"use strict";var e=require("react"),t=require("react/jsx-runtime");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,o.get?o:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var o=n(e);const r={high:[],normal:[],low:[]};let a=!1;const s=e=>{var t,n,o;for(a=!0;r.high.length||r.normal.length||r.low.length;)if(r.high.length)null===(t=r.high.shift())||void 0===t||t();else if(r.normal.length)null===(n=r.normal.shift())||void 0===n||n();else if(r.low.length){if(void 0!==e&&e.timeRemaining()<1)break;null===(o=r.low.shift())||void 0===o||o()}a=!1,r.low.length>0&&("undefined"!=typeof requestIdleCallback?requestIdleCallback(s):setTimeout(()=>s(),16))};function i(e,t="normal"){r[t].push(e),a||("high"===t?s():"undefined"!=typeof requestIdleCallback?requestIdleCallback(s):setTimeout(()=>s(),16))}const c={activeNode:null,activeEffect:null};let l=0;const u=new Map;function f(e,t,n){const o={id:++l,type:e,name:t,value:n,deps:new Set,highlighted:!1};return u.set(o.id,o),o}function d(e,t){e.deps.add(t.id)}function v(){return Array.from(u.values()).map(e=>({id:e.id,name:e.name,type:e.type,value:e.value,deps:Array.from(e.deps),highlighted:e.highlighted}))}function h(e){let t=e;const n=new Set,o=f("atom"),r=()=>(c.activeNode&&d(c.activeNode,o),c.activeEffect&&n.add(c.activeEffect),t);return r.set=(e,r="normal")=>{Object.is(e,t)||(t=e,o.value=t,n.forEach(e=>i(e,r)))},r}function p(e){let t,n=!0;const o=new Set,r=f("computed"),a=()=>{n||(n=!0,o.forEach(e=>i(e)))};return()=>{if(c.activeNode&&d(c.activeNode,r),c.activeEffect&&o.add(c.activeEffect),n){const o=c.activeNode,s=c.activeEffect;c.activeNode=r,c.activeEffect=a,t=e(),n=!1,c.activeNode=o,c.activeEffect=s}return t}}function m(e,t="normal"){const n=f("effect","Effect"),o=[],r=()=>{try{c.activeNode=n,c.activeEffect=r,e()}catch(e){console.error("[Effect error]",e)}finally{c.activeNode=null,c.activeEffect=null}};return i(r,t),()=>{n.deps.clear(),o.forEach(e=>e())}}function g(e,t,n="normal"){return m(()=>{const n=e();t(n)},n)}const x=new Set;function y(e){e(),x.forEach(e=>i(e)),x.clear()}function w(e){const t=h(e.initial);return{state:t,dispatch:async function(n,o){var r;const a=t(),s=e.states[a.status],i=null===(r=null==s?void 0:s.on)||void 0===r?void 0:r[n];if(i){const e=i({state:a,payload:o}),n=e instanceof Promise?await e:e;y(()=>t.set(n))}}}}const E=w({initial:{status:"idle"},states:{idle:{on:{VALIDATE:()=>({status:"validating"})}},validating:{on:{SUCCESS:()=>({status:"valid"}),ERROR:()=>({status:"invalid"})}},valid:{},invalid:{}}});function b(e){const[,t]=o.useState(0);return o.useEffect(()=>{const n=m(()=>{e(),t(e=>e+1)},"normal");return()=>n()},[e]),e()}exports.DevtoolsReactPanel=function(){const[n,o]=e.useState(v());return e.useEffect(()=>{const e=setInterval(()=>o(v()),100);return()=>clearInterval(e)},[]),t.jsx("div",{style:{fontFamily:"monospace",fontSize:12,background:"#222",color:"#eee",padding:10,maxHeight:300,overflowY:"auto"},children:n.map(e=>t.jsxs("div",{children:["[",e.type,"] ",e.name||"anon"," â†’ deps: ",e.deps.join(", ")]},e.id))})},exports.asyncAtom=function(e){const t=h(void 0);let n=null,o=!1;const r=()=>(n||(n=e().then(e=>(o||t.set(e,"low"),e)),n.finally(()=>n=null)),n);return Object.assign(()=>{const e=t();if(void 0===e)throw r();return e},{set:t.set,load:r,cancel:()=>{o=!0}})},exports.asyncComputed=function(e,t){const n=p(()=>{}),o=f("computed","asyncComputed");let r=null,a=!1,s=null;const l=()=>{if(c.activeNode&&d(c.activeNode,o),r||(a=!1,s=null,r=e().then(e=>(a||n.set(e),e)).catch(e=>{a||(s=e)}).finally(()=>r=null)),s)throw s;if(void 0===n())throw r;return n()};return Object.assign(l,{load:()=>r,invalidate:(e="normal")=>{a=!0,r=null,i(l,(null==t?void 0:t.priority)||e)},node:o})},exports.atom=h,exports.batch=y,exports.clearHighlights=function(){u.forEach(e=>{e.highlighted=!1})},exports.computed=p,exports.createFSM=w,exports.createField=function(e,t){const n=h({value:e,touched:!1}),o=p(()=>t?t(n().value):void 0);return{state:n,error:o,setValue:e=>n.set({...n(),value:e}),touch:()=>n.set({...n(),touched:!0})}},exports.createIntentBus=function(){const e=new Map;return{on(t,n){e.set(t,n)},dispatch(t,n){const o=e.get(n.type);o&&o({state:t(),intent:n,setState:t.set})}}},exports.createNestedForm=function(e){const t={};for(const n in e){const o=e[n],r=h({value:o.initial,error:null});o.validate&&g(r,async e=>{try{const t=await o.validate(e.value);y(()=>{r.set({...r(),error:null!=t?t:null})})}catch(e){r.set({...r(),error:e.message})}}),t[n]=r}const n=()=>Object.fromEntries(Object.entries(t).map(([e,t])=>[e,t().value])),o=async()=>(await Promise.all(Object.values(t).map(e=>e().error))).every(e=>null==e);return{fields:t,values:n,isValid:o,setField:(e,n)=>{const o=t[e];o&&y(()=>o.set({...o(),value:n}))},submit:async()=>{if(!await o())throw new Error("Validation failed");return n()}}},exports.effect=m,exports.effectContext=c,exports.getGraphSnapshot=v,exports.highlightNode=function(e){const t=u.get(e);t&&(t.highlighted=!0)},exports.linkNodes=d,exports.resetGraph=function(){u.clear(),l=0},exports.schedule=i,exports.scheduleCancelable=function(e,t="normal"){let n=!1;return i(()=>{n||e()},t),()=>{n=!0}},exports.scheduleReactJob=function(t,n="normal"){"low"===n?e.startTransition(t):t()},exports.trackNode=f,exports.transaction=function(e){y(e)},exports.updateNodeValue=function(e,t){e.value=t},exports.useAtom=b,exports.useBatch=function(){return y},exports.useComputed=function(e){return b(o.useMemo(()=>p(e),[e]))},exports.useEffectReact=function(e,t="normal"){o.useEffect(()=>{const n=m(e,t);return()=>n()},[e,t])},exports.useField=function(e,t){const n=h(e),o=h(null);return t&&g(n,e=>{const n=t(e);o.set(n)}),{value:n,error:o}},exports.useForm=function(e){const t={};for(const n in e){const o=h({value:e[n].initial,error:null});t[n]=o,e[n].validate&&g(o,async t=>{try{const r=await e[n].validate(t.value);y(()=>o.set({...t,error:r}))}catch(e){y(()=>o.set({...t,error:e.message}))}})}const n=async()=>(await Promise.all(Object.values(t).map(e=>e().error))).every(e=>null==e),o=()=>Object.fromEntries(Object.entries(t).map(([e,t])=>[e,t().value]));return{fields:t,setField:(e,n)=>{const o=t[e];o&&y(()=>o.set({...o(),value:n}))},isValid:n,values:o,submit:async()=>{if(!await n())throw new Error("Validation failed");return o()}}},exports.useWatch=function(e,t){o.useEffect(()=>{const n=g(e,t);return()=>null==n?void 0:n()},[e,t])},exports.validationFSM=E,exports.watch=g;

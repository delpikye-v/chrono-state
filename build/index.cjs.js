"use strict";var e=require("intentx-core-z"),t=require("react");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var r=n(t);const c={activeEffect:null};function o(t){let n=t;const r=new Set,o=new Set,u=()=>(c.activeEffect&&o.add(c.activeEffect),n);return u.set=(t,c="normal")=>{Object.is(t,n)||(n=t,o.forEach(t=>e.schedule(t,c)),r.forEach(e=>e()))},u.subscribe=e=>(r.add(e),()=>r.delete(e)),u}function u(t){let n,r=!0;const o=new Set,u=()=>{r||(r=!0,o.forEach(t=>e.schedule(t)))};return()=>{if(c.activeEffect&&o.add(c.activeEffect),r){const e=c.activeEffect;c.activeEffect=u,n=t(),r=!1,c.activeEffect=e}return n}}function s(t,n="normal"){let r=null,o=!1;const u=()=>{if(!o){null==r||r();try{c.activeEffect=u;const e=t();"function"==typeof e&&(r=e)}finally{c.activeEffect=null}}};return e.schedule(u,n),()=>{o=!0,null==r||r(),r=null}}function l(e,t,n="normal"){return s(()=>{t(e())},n)}const a=e.createScope("default");function f(e){return r.useSyncExternalStore(t=>{let n=e();return s(()=>{const r=e();Object.is(n,r)||(n=r,t())})},e,e)}Object.defineProperty(exports,"createScope",{enumerable:!0,get:function(){return e.createScope}}),Object.defineProperty(exports,"transaction",{enumerable:!0,get:function(){return e.batch}}),exports.asyncAtom=function(t){const n=o(null);let r=null,c=!1;const u=()=>(r||(c=!1,r=t().then(e=>(c||n.set(e),e)).finally(()=>{r=null})),r),s=()=>{c=!0,r=null},l=()=>{const e=n();if(null===e)throw u();return e};return l.set=n.set,l.load=u,l.cancel=s,l.invalidate=(t="normal")=>{s(),e.schedule(()=>{try{u()}catch{}},t)},l},exports.asyncComputed=function(t,n="normal"){const r=o(void 0);let c=null,u=!1,s=null;const l=()=>(c||(u=!1,s=null,c=t().then(e=>(u||r.set(e,n),e)).catch(e=>{throw u||(s=e),e}).finally(()=>{c=null})),c),a=()=>{const e=r();if(s)throw s;if(void 0===e)throw l();return e};return a.invalidate=(t=n)=>{u=!0,c=null,e.schedule(()=>{try{l()}catch{}},t)},a},exports.atom=o,exports.computed=u,exports.createSelector=function(e,t=Object.is){let n,r=!1;return c=>{const o=e(c);return r&&t(n,o)?n:(r=!0,n=o,o)}},exports.createStore=function(t,n=a){let r=t;const c=new Set,o=e.createIntentBus((e,t)=>{const n=new AbortController;return{payload:e,scope:t,state:r,signal:n.signal,setState(e){e(r),c.forEach(e=>e())},emit:(e,n)=>o.emit(e,n,t)}});return{scope:n,state:()=>r,setState(e){e(r),c.forEach(e=>e())},subscribe:e=>(c.add(e),()=>c.delete(e)),emit:(e,t)=>o.emit(e,t,n),on:(e,t)=>o.on(e,t,n)}},exports.createTestRuntime=function(){let e=[];return{schedule(t){e.push(t)},flushEffects(){for(;e.length;)e.shift()()}}},exports.defaultScope=a,exports.effect=s,exports.factoryAtom=function(e){const t=new Map;return n=>{let r=t.get(n);return r||(r=e(n),t.set(n,r)),r}},exports.scheduleReactJob=function(e,n="normal"){"low"===n?t.startTransition(e):e()},exports.useAtom=f,exports.useBatch=function(){return e.batch},exports.useComputed=function(e){return f(r.useMemo(()=>u(e),[e]))},exports.useEffectReact=function(e,t="normal"){r.useEffect(()=>{const n=s(e,t);return()=>n()},[e,t])},exports.useFactoryAtom=function(e,t){return f(e(t))},exports.useStore=function(e){return t.useSyncExternalStore(e.subscribe,e.state,e.state)},exports.useStoreSelector=function(e,n,r=Object.is){const c=t.useRef(null),o=()=>{const t=n(e.state()),o=c.current;return null!==o&&r(o,t)?o:(c.current=t,t)};return t.useSyncExternalStore(e.subscribe,o,o)},exports.useWatch=function(e,t){r.useEffect(()=>{const n=l(e,t);return()=>null==n?void 0:n()},[e,t])},exports.watch=l;

import*as t from"react";import e,{startTransition as n}from"react";import{jsx as o,jsxs as a}from"react/jsx-runtime";const i={high:[],normal:[],low:[]};let l=!1;const r=t=>{var e,n,o;for(l=!0;i.high.length||i.normal.length||i.low.length;)if(i.high.length)null===(e=i.high.shift())||void 0===e||e();else if(i.normal.length)null===(n=i.normal.shift())||void 0===n||n();else if(i.low.length){if(void 0!==t&&t.timeRemaining()<1)break;null===(o=i.low.shift())||void 0===o||o()}l=!1,i.low.length>0&&("undefined"!=typeof requestIdleCallback?requestIdleCallback(r):setTimeout(()=>r(),16))};function c(t,e="normal"){i[e].push(t),l||("high"===e?r():"undefined"!=typeof requestIdleCallback?requestIdleCallback(r):setTimeout(()=>r(),16))}function s(t,e="normal"){let n=!1;return c(()=>{n||t()},e),()=>{n=!0}}const u={activeNode:null,activeEffect:null};let f=0;const d=new Map;function v(t,e,n){const o={id:++f,type:t,name:e,value:n,deps:new Set,highlighted:!1};return d.set(o.id,o),o}function h(t,e){t.deps.add(e.id)}function m(t,e){t.value=e}function p(){return Array.from(d.values()).map(t=>({id:t.id,name:t.name,type:t.type,value:t.value,deps:Array.from(t.deps),highlighted:t.highlighted}))}function g(t){const e=d.get(t);e&&(e.highlighted=!0)}function y(){d.forEach(t=>{t.highlighted=!1})}function w(){d.clear(),f=0}function E(t){let e=t;const n=new Set,o=v("atom"),a=()=>(u.activeNode&&h(u.activeNode,o),u.activeEffect&&n.add(u.activeEffect),e);return a.set=(t,a="normal")=>{Object.is(t,e)||(e=t,o.value=e,n.forEach(t=>c(t,a)))},a}function b(t){const e=E(void 0);let n=null,o=!1;const a=()=>(n||(n=t().then(t=>(o||e.set(t,"low"),t)),n.finally(()=>n=null)),n);return Object.assign(()=>{const t=e();if(void 0===t)throw a();return t},{set:e.set,load:a,cancel:()=>{o=!0}})}function N(t){let e,n=!0;const o=new Set,a=v("computed"),i=()=>{n||(n=!0,o.forEach(t=>c(t)))};return()=>{if(u.activeNode&&h(u.activeNode,a),u.activeEffect&&o.add(u.activeEffect),n){const o=u.activeNode,l=u.activeEffect;u.activeNode=a,u.activeEffect=i,e=t(),n=!1,u.activeNode=o,u.activeEffect=l}return e}}function j(t,e="normal"){const n=v("effect","Effect"),o=[],a=()=>{try{u.activeNode=n,u.activeEffect=a,t()}catch(t){console.error("[Effect error]",t)}finally{u.activeNode=null,u.activeEffect=null}};return c(a,e),()=>{n.deps.clear(),o.forEach(t=>t())}}function S(t,e,n="normal"){return j(()=>{const n=t();e(n)},n)}const O=new Set;function C(t){t(),O.forEach(t=>c(t)),O.clear()}function I(t,e){const n=N(()=>{}),o=v("computed","asyncComputed");let a=null,i=!1,l=null;const r=()=>{if(u.activeNode&&h(u.activeNode,o),a||(i=!1,l=null,a=t().then(t=>(i||n.set(t),t)).catch(t=>{i||(l=t)}).finally(()=>a=null)),l)throw l;if(void 0===n())throw a;return n()};return Object.assign(r,{load:()=>a,invalidate:(t="normal")=>{i=!0,a=null,c(r,(null==e?void 0:e.priority)||t)},node:o})}function k(t){C(t)}function V(){const t=new Map;return{on(e,n){t.set(e,n)},dispatch(e,n){const o=t.get(n.type);o&&o({state:e(),intent:n,setState:e.set})}}}function q(t){const e=E(t.initial);return{state:e,dispatch:async function(n,o){var a;const i=e(),l=t.states[i.status],r=null===(a=null==l?void 0:l.on)||void 0===a?void 0:a[n];if(r){const t=r({state:i,payload:o}),n=t instanceof Promise?await t:t;C(()=>e.set(n))}}}}function A(t,e){const n=E({value:t,touched:!1}),o=N(()=>e?e(n().value):void 0);return{state:n,error:o,setValue:t=>n.set({...n(),value:t}),touch:()=>n.set({...n(),touched:!0})}}function R(t,e){const n=E(t),o=E(null);return e&&S(n,t=>{const n=e(t);o.set(n)}),{value:n,error:o}}function x(t){const e={};for(const n in t){const o=E({value:t[n].initial,error:null});e[n]=o,t[n].validate&&S(o,async e=>{try{const a=await t[n].validate(e.value);C(()=>o.set({...e,error:a}))}catch(t){C(()=>o.set({...e,error:t.message}))}})}const n=async()=>(await Promise.all(Object.values(e).map(t=>t().error))).every(t=>null==t),o=()=>Object.fromEntries(Object.entries(e).map(([t,e])=>[t,e().value]));return{fields:e,setField:(t,n)=>{const o=e[t];o&&C(()=>o.set({...o(),value:n}))},isValid:n,values:o,submit:async()=>{if(!await n())throw new Error("Validation failed");return o()}}}function F(t){const e={};for(const n in t){const o=t[n],a=E({value:o.initial,error:null});o.validate&&S(a,async t=>{try{const e=await o.validate(t.value);C(()=>{a.set({...a(),error:null!=e?e:null})})}catch(t){a.set({...a(),error:t.message})}}),e[n]=a}const n=()=>Object.fromEntries(Object.entries(e).map(([t,e])=>[t,e().value])),o=async()=>(await Promise.all(Object.values(e).map(t=>t().error))).every(t=>null==t);return{fields:e,values:n,isValid:o,setField:(t,n)=>{const o=e[t];o&&C(()=>o.set({...o(),value:n}))},submit:async()=>{if(!await o())throw new Error("Validation failed");return n()}}}const M=q({initial:{status:"idle"},states:{idle:{on:{VALIDATE:()=>({status:"validating"})}},validating:{on:{SUCCESS:()=>({status:"valid"}),ERROR:()=>({status:"invalid"})}},valid:{},invalid:{}}});function P(t,e="normal"){"low"===e?n(t):t()}function T(e){const[,n]=t.useState(0);return t.useEffect(()=>{const t=j(()=>{e(),n(t=>t+1)},"normal");return()=>t()},[e]),e()}function z(e){return T(t.useMemo(()=>N(e),[e]))}function D(e,n){t.useEffect(()=>{const t=S(e,n);return()=>null==t?void 0:t()},[e,n])}function H(){return C}function L(e,n="normal"){t.useEffect(()=>{const t=j(e,n);return()=>t()},[e,n])}function U(){const[t,n]=e.useState(p());return e.useEffect(()=>{const t=setInterval(()=>n(p()),100);return()=>clearInterval(t)},[]),o("div",{style:{fontFamily:"monospace",fontSize:12,background:"#222",color:"#eee",padding:10,maxHeight:300,overflowY:"auto"},children:t.map(t=>a("div",{children:["[",t.type,"] ",t.name||"anon"," â†’ deps: ",t.deps.join(", ")]},t.id))})}export{U as DevtoolsReactPanel,b as asyncAtom,I as asyncComputed,E as atom,C as batch,y as clearHighlights,N as computed,q as createFSM,A as createField,V as createIntentBus,F as createNestedForm,j as effect,u as effectContext,p as getGraphSnapshot,g as highlightNode,h as linkNodes,w as resetGraph,c as schedule,s as scheduleCancelable,P as scheduleReactJob,v as trackNode,k as transaction,m as updateNodeValue,T as useAtom,H as useBatch,z as useComputed,L as useEffectReact,R as useField,x as useForm,D as useWatch,M as validationFSM,S as watch};
